# Alura - PostgreSQL: Primeiros passos com SQL

## Configurar o acesso remoto PostgreSQL Server, siga os passos abaixo:

    1. **Editar o arquivo `postgresql.conf`:**
       - Localize o arquivo `postgresql.conf`. Geralmente, ele est√° no diret√≥rio de dados do PostgreSQL, como `/etc/postgresql/17/main/` ou similar.
       - Abra o arquivo com um editor de texto, por exemplo: `sudo nano /etc/postgresql/17/main/postgresql.conf`.
       - Encontre a linha `#listen_addresses = 'localhost'` e altere para: `listen_addresses = '*'`.
       - Salve e feche o arquivo.
    
    2. **Configurar o arquivo `pg_hba.conf`:**
       - Localize o arquivo `pg_hba.conf`, que geralmente est√° no mesmo diret√≥rio do `postgresql.conf`.
       - Adicione uma linha ao final do arquivo para permitir conex√µes de qualquer IP (ou especifique um intervalo de IPs confi√°veis):
         ```
         host    all             all             0.0.0.0/0            md5
         ```
       - Salve e feche o arquivo.
    
    3. **Reiniciar o servi√ßo PostgreSQL:**
       - Ap√≥s as altera√ß√µes, reinicie o servi√ßo para aplicar as configura√ß√µes:
         ```
         sudo systemctl restart postgresql
         ```
    
    4. **Abrir a porta 5432 no firewall:**
       - Certifique-se de que a porta 5432 est√° aberta para conex√µes externas. No Ubuntu, voc√™ pode usar o `ufw`:
         ```
         sudo ufw allow 5432/tcp
         ```
    
    5. **Testar a conex√£o:**
       - No seu desktop Linux ou Windows, use ferramentas como `psql`, `pgAdmin` ou DBeaver para testar a conex√£o.
       - Configure a conex√£o com o IP do servidor (ou hostname), porta 5432, nome do banco de dados, usu√°rio e senha.
    
---

## Explica√ß√£o do arquivo `pg_hba.conf`

No arquivo `pg_hba.conf`, voc√™ configura como e quem pode se conectar ao seu banco de dados PostgreSQL. Ele √© uma lista de regras de controle de acesso. Cada linha representa uma regra, e ao adicionar uma nova linha, voc√™ est√° especificando uma nova permiss√£o de acesso.

Aqui est√° um exemplo pr√°tico com mais detalhes:

1. **Estrutura da linha:**
   ```
   host    all    all    <IP_RANGE>    <AUTHENTICATION_METHOD>
   ```

   - **host:** indica que essa regra √© para conex√µes TCP/IP (remotas).
   - **all (primeiro):** indica que a regra se aplica a qualquer banco de dados. Voc√™ pode substituir por um nome espec√≠fico de banco de dados, caso queira restringir.
   - **all (segundo):** permite qualquer usu√°rio. Tamb√©m pode ser substitu√≠do por um nome de usu√°rio espec√≠fico.
   - **<IP_RANGE>:** √© o intervalo de endere√ßos IP que podem se conectar. Exemplos:
     - `0.0.0.0/0` (qualquer endere√ßo IP). **Use com cuidado!**
     - `192.168.1.0/24` (apenas endere√ßos dentro da faixa de 192.168.1.1 a 192.168.1.254).
   - **<AUTHENTICATION_METHOD>:** o m√©todo de autentica√ß√£o usado para essas conex√µes. Exemplos:
     - `md5`: exige senha com hash MD5.
     - `trust`: permite acesso sem senha (n√£o recomendado para produ√ß√£o).

2. **Exemplo de linha para qualquer IP:**
   ```
   host    all    all    0.0.0.0/0    md5
   ```

   Com esta configura√ß√£o:
   - Usu√°rios de qualquer IP podem tentar se conectar ao PostgreSQL.
   - Eles devem fornecer o nome de usu√°rio e senha corretos.

3. **Melhores pr√°ticas:**
   - Se poss√≠vel, use intervalos de IPs espec√≠ficos em vez de `0.0.0.0/0`. Por exemplo:
     ```
     host    all    all    192.168.1.0/24    md5
     ```
   - Isso restringe o acesso apenas a m√°quinas da sua rede local.

   - Evite m√©todos de autentica√ß√£o inseguros, como `trust`, em ambientes de produ√ß√£o.

Depois de editar e salvar o arquivo, lembre-se de reiniciar o servi√ßo PostgreSQL para aplicar as mudan√ßas.

---

## Seguran√ßa de Senhas no PostgreSQL

A seguran√ßa das senhas √© um aspecto cr√≠tico na administra√ß√£o de bancos de dados. O PostgreSQL oferece v√°rias op√ß√µes para proteger as credenciais de acesso, garantindo que apenas usu√°rios autorizados possam acessar os dados.

Aqui est√£o algumas **melhores pr√°ticas** para gerenciar senhas de maneira segura:

### üîë **1. Use m√©todos de autentica√ß√£o seguros**

O PostgreSQL suporta diferentes m√©todos de autentica√ß√£o no arquivo `pg_hba.conf`. Os mais recomendados s√£o:

- **`scram-sha-256`** (mais seguro e moderno)
- **`md5`** (ainda usado, mas menos seguro)

Exemplo:

```bash
host    all    all    192.168.0.0/24    scram-sha-256
```

### üîí **2. Nunca armazene senhas em texto plano**

Evite definir senhas diretamente no c√≥digo ou arquivos de configura√ß√£o. Prefira vari√°veis de ambiente:

```bash
export PGPASSWORD="minha_senha_segura"
psql -U meu_usuario -h servidor -d banco
```

### üõ°Ô∏è **3. Gere senhas fortes**

Use senhas longas e aleat√≥rias com **letras mai√∫sculas, min√∫sculas, n√∫meros e caracteres especiais**. Exemplo de gera√ß√£o de senha segura via terminal:

```bash
openssl rand -base64 32
```

### ‚öôÔ∏è **4. Altere senhas regularmente**

Defina uma pol√≠tica de rota√ß√£o de senhas para usu√°rios cr√≠ticos, mudando-as periodicamente.

### üöÄ **5. Restrinja privil√©gios dos usu√°rios**

Evite usar `postgres` para tarefas rotineiras. Crie usu√°rios espec√≠ficos com permiss√µes limitadas:

```sql
CREATE USER meu_usuario WITH PASSWORD 'senha_forte' NOSUPERUSER;
```

### üìú **6. Use extens√µes de seguran√ßa**

Considere a extens√£o `pgcrypto` para armazenar senhas hashadas em tabelas:

```sql
SELECT crypt('senha_segura', gen_salt('bf'));
```

Essas pr√°ticas ajudam a manter seu banco de dados protegido contra acessos indevidos.

---

## Configurando SCRAM-SHA-256 no PostgreSQL

**SCRAM-SHA-256** √© um dos m√©todos mais seguros para autentica√ß√£o no PostgreSQL. Aqui est√° um guia passo a passo para configurar e usar esse m√©todo corretamente:

### 1Ô∏è‚É£ **Configurar `pg_hba.conf` para usar SCRAM-SHA-256**

Edite o arquivo `pg_hba.conf` e substitua o m√©todo de autentica√ß√£o de seus usu√°rios para `scram-sha-256`:

```bash
host    all    all    192.168.0.0/24    scram-sha-256
```

Depois de fazer essa altera√ß√£o, reinicie o PostgreSQL para aplicar as mudan√ßas:

```bash
sudo systemctl restart postgresql
```

### 2Ô∏è‚É£ **Alterar a senha do usu√°rio para o formato correto**

Para que um usu√°rio utilize SCRAM-SHA-256, voc√™ precisa garantir que a senha dele seja armazenada nesse formato. No PostgreSQL, execute:

```sql
ALTER USER meu_usuario WITH PASSWORD 'senha_segura';
```

Isso automaticamente armazena a senha no formato **SCRAM-SHA-256**, desde que o PostgreSQL esteja configurado corretamente.

### 3Ô∏è‚É£ **Verificar se a senha est√° armazenada corretamente**

Confira no banco se a senha foi configurada para usar `SCRAM-SHA-256`:

```sql
SELECT rolname, rolpassword FROM pg_authid WHERE rolname = 'meu_usuario';
```

A senha n√£o ser√° vis√≠vel, mas voc√™ ver√° algo como:

```
meu_usuario  SCRAM-SHA-256$...
```

Se aparecer `MD5`, significa que a senha foi armazenada no formato antigo. Para corrigir isso, altere a senha novamente usando `ALTER USER`, como mostrado no passo anterior.

### 4Ô∏è‚É£ **Testar a conex√£o**

Agora, tente conectar ao PostgreSQL usando `psql` ou outro cliente que suporte SCRAM-SHA-256:

```bash
psql -U meu_usuario -h 192.168.0.xxx -d meu_banco
```

Se tudo estiver configurado corretamente, voc√™ deve conseguir se conectar sem problemas.

### 5Ô∏è‚É£ **Considera√ß√µes Finais**

- **Compatibilidade:** Certifique-se de que o cliente PostgreSQL que voc√™ est√° usando suporta SCRAM-SHA-256. Vers√µes mais antigas podem n√£o ter suporte.
- **Seguran√ßa:** SCRAM-SHA-256 √© mais seguro que MD5, pois protege contra ataques de for√ßa bruta e replay. Sempre que poss√≠vel, use esse m√©todo para autentica√ß√£o.
- **Monitoramento:** Considere monitorar logs de autentica√ß√£o para detectar tentativas de acesso n√£o autorizadas.
- **Documenta√ß√£o:** Consulte a [documenta√ß√£o oficial do PostgreSQL](https://www.postgresql.org/docs/current/auth-methods.html) para mais detalhes sobre m√©todos de autentica√ß√£o e seguran√ßa.

---
